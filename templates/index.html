<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gene Expression Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            /* Soft blue-violet gradient */
            background: linear-gradient(120deg, #e0e7ff 0%, #f9fafb 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="p-6">
    <div id="loading-spinner" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:9999; align-items:center; justify-content:center;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-600 border-solid"></div>
        <span class="ml-4 text-blue-700 font-bold text-lg">Loading...</span>
    </div>

    <h1 id="main-title" class="text-4xl font-bold text-center text-blue-700 mb-8">Gene Expression Explorer</h1>

    <div class="flex flex-col lg:flex-row justify-center gap-8">
        <!-- Left Column: Form -->
        <div class="bg-white p-6 rounded-lg shadow-lg w-full lg:w-1/3">
            <form method="POST">
                <div class="mb-4">
                    <label for="gene" class="block text-gray-700 font-semibold mb-2">Enter Gene Symbol</label>
                    <input type="text" name="gene" id="gene" class="w-full p-3 border border-gray-300 rounded-lg" 
                           placeholder="e.g., TP53" required value="{{ gene if gene }}">
                    <small class="text-gray-500">Try symbols like <code>TP53</code>, <code>BRCA1</code></small>
                    {% if result and result.error %}
                    <div class="mt-2 p-4 rounded-lg bg-red-50 border border-red-200">
                        <p class="text-red-600">{{ result.error }}</p>
                        {% if result.suggestion %}
                            <p class="mt-2 text-blue-700 text-sm font-semibold">{{ result.suggestion }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="mb-4">
                    <label for="dataset" class="block text-gray-700 font-semibold mb-2">Select Dataset</label>
                    <select name="dataset" id="dataset" class="w-full p-3 border border-gray-300 rounded-lg" required>
                        {% for dataset in datasets %}
                            <option value="{{ dataset }}" {% if selected_dataset == dataset %}selected{% endif %}>{{ dataset }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label for="plot_type" class="block text-gray-700 font-semibold mb-2">Select Plot Type</label>
                    <select name="plot_type" id="plot_type" class="w-full p-3 border border-gray-300 rounded-lg">
                        <option value="bar" {% if plot_type == "bar" %}selected{% endif %}>Bar Plot</option>
                        <option value="box" {% if plot_type == "box" %}selected{% endif %}>Box Plot</option>
                        <option value="violin" {% if plot_type == "violin" %}selected{% endif %}>Violin Plot</option>
                    </select>
                </div>
                <button type="submit" class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition">Analyze</button>
            </form>

            <!-- Top Genes Table -->
            {% if top_genes %}
            <h2 class="mt-8 text-lg font-bold text-gray-700">Top Differentially Expressed Genes</h2>
            <table id="top-genes-table" class="w-full mt-4 text-sm text-left border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2">Gene</th>
                        <th class="p-2">Log2FC</th>
                        <th class="p-2">p-value</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gene in top_genes %}
                    <tr class="border-t">
                        <td class="p-2">{{ gene.gene }}</td>
                        <td class="p-2">{{ gene.log2fc|round(2) }}</td>
                        <td class="p-2">{{ "%.2e"|format(gene.pval) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <a id="download-csv" href="{{ url_for('static', filename='top_genes.csv') }}" download class="text-blue-600 hover:underline mt-2 inline-block">ðŸ“¥ Download CSV</a>
            {% endif %}
        </div>

        <!-- Right Column: Results + Plots -->
        <div class="w-full lg:w-1/2 flex flex-col gap-6">
            {% if result %}
            <div id="results-card" class="results mt-6">
                <h3 class="font-bold text-lg mb-2">Results for Gene: {{ result.gene }}</h3>
                <p><b>Dataset:</b> {{ result.dataset }}</p>
                <p><b>Healthy Avg:</b> <span id="healthy-avg">{{ result.healthy_avg }}</span></p>
                <p><b>Disease Avg:</b> {{ result.disease_avg }}</p>
                <p><b>Healthy Std Dev:</b> {{ result.healthy_std }}</p>
                <p><b>Disease Std Dev:</b> {{ result.disease_std }}</p>
                <p><b>Log2 Fold Change:</b> {{ result.log2fc }}</p>
                <p><b>P-value:</b> {{ result.pval }}</p>
            </div>
            {% endif %}

            {% if plot_exists %}
            <div class="plot-container mx-auto my-4">
                <img id="plot-img" src="{{ url_for('static', filename='plot.png') }}" alt="Gene Expression Plot" style="max-width:100%; border-radius:12px; box-shadow:0 2px 12px rgba(42,82,152,0.10); background:#fff;">
            </div>
            {% endif %}

            {% if heatmap_exists %}
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Top Genes Heatmap</h3>
                <img src="{{ url_for('static', filename='heatmap.png') }}" alt="Heatmap" class="mx-auto max-w-full rounded-lg shadow">
            </div>
            {% endif %}

            {% if pie_exists %}
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">Sample Class Distribution</h3>
                <img src="{{ url_for('static', filename='pie.png') }}" alt="Class Distribution" class="mx-auto max-w-xs rounded-lg shadow">
            </div>
            {% endif %}

            <!-- GO Terms Enrichment Section -->
            {% if go_terms and go_terms|length > 0 %}
            <div class="bg-white p-4 rounded-lg shadow mt-4 mb-4">
                <h3 class="text-lg font-bold text-purple-700 mb-2">GO Enrichment (Top Biological Processes)</h3>
                <ul class="list-disc ml-6">
                    {% for term in go_terms %}
                    <li>
                        <a href="https://www.ebi.ac.uk/QuickGO/term/{{ term.term_id }}" target="_blank" class="text-blue-600 hover:underline">
                            {{ term.name }} ({{ term.term_id }})
                        </a>
                        <span class="text-gray-500 text-xs ml-2">p = {{ "%.2e"|format(term.p_value) }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Gene Information Section -->
            {% if gene_info %}
            <div class="bg-white p-4 rounded-lg shadow-lg mb-4 results">
                <h3 class="text-lg font-bold text-blue-700 mb-2">Gene Information</h3>
                <p><b>Symbol:</b> {{ gene_info.symbol }}</p>
                {% if gene_info.name %}<p><b>Name:</b> {{ gene_info.name }}</p>{% endif %}
                {% if gene_info.summary %}<p><b>Function:</b> {{ gene_info.summary }}</p>{% endif %}
                {% if gene_info.chrom %}<p><b>Chromosome:</b> {{ gene_info.chrom }}</p>{% endif %}
                {% if gene_info.location %}<p><b>Location:</b> {{ gene_info.location }}</p>{% endif %}
                {% if gene_info.entrez %}<p><b>Entrez ID:</b> {{ gene_info.entrez }}</p>{% endif %}
                {% if gene_info.uniprot %}<p><b>UniProt:</b> {{ gene_info.uniprot }}</p>{% endif %}
                {% if gene_info.diseases and gene_info.diseases|length > 0 %}
                    <div class="mt-2">
                        <b>Associated Diseases:</b>
                        <ul class="list-disc ml-6">
                            {% for d in gene_info.diseases %}
                                <li>{{ d.name }} (score: {{ d.score }})</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</body>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Animate main title
    if (document.getElementById('main-title')) {
        anime({
            targets: '#main-title',
            opacity: [0, 1],
            translateY: [-30, 0],
            duration: 900,
            easing: 'easeOutExpo'
        });
    }
    // Animate results card
    if (document.getElementById('results-card')) {
        anime({
            targets: '#results-card',
            opacity: [0, 1],
            translateY: [40, 0],
            duration: 700,
            easing: 'easeOutExpo'
        });
    }
    // Animate plot image
    if (document.getElementById('plot-img')) {
        anime({
            targets: '#plot-img',
            opacity: [0, 1],
            scale: [0.85, 1],
            duration: 800,
            delay: 100,
            easing: 'easeOutBack'
        });
    }
    // Animate top genes table
    if (document.getElementById('top-genes-table')) {
        anime({
            targets: '#top-genes-table',
            opacity: [0, 1],
            translateY: [30, 0],
            duration: 700,
            delay: 200,
            easing: 'easeOutExpo'
        });
    }
    // Animate download button
    if (document.getElementById('download-csv')) {
        anime({
            targets: '#download-csv',
            opacity: [0, 1],
            scale: [0.8, 1],
            duration: 700,
            delay: 400,
            easing: 'easeOutBack'
        });
    }
    // Animate heatmap
    if (document.querySelector('img[alt="Heatmap"]')) {
        anime({
            targets: 'img[alt="Heatmap"]',
            opacity: [0, 1],
            scale: [0.8, 1],
            duration: 900,
            delay: 200,
            easing: 'easeOutBack'
        });
    }
    // Animate pie chart
    if (document.querySelector('img[alt="Class Distribution"]')) {
        anime({
            targets: 'img[alt="Class Distribution"]',
            opacity: [0, 1],
            scale: [0.8, 1],
            duration: 900,
            delay: 200,
            easing: 'easeOutBack'
        });
    }
    // Animated counter for results (optional)
    function animateNumber(id, endVal) {
        let el = document.getElementById(id);
        if (!el) return;
        anime({
            targets: {value: 0},
            value: endVal,
            round: 100,
            duration: 1000,
            easing: 'easeOutExpo',
            update: function(anim) {
                el.textContent = anim.animations[0].currentValue.toFixed(2);
            }
        });
    }
    if (document.getElementById('healthy-avg')) {
        animateNumber('healthy-avg', parseFloat(document.getElementById('healthy-avg').textContent));
    }
    if (document.getElementById('disease-avg')) {
        animateNumber('disease-avg', parseFloat(document.getElementById('disease-avg').textContent));
    }

    var form = document.querySelector("form");
    if(form) {
        form.addEventListener("submit", function() {
            document.getElementById("loading-spinner").style.display = "flex";
        });
    }
});
</script>
</html>
